<!DOCTYPE html>
<html>

<head>
    <title>Invitation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/turn.js"></script>
    <style>
        /* Hide all content initially */
        #flipbook,
        #controls {
            opacity: 0;
            visibility: hidden;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #loading-text {
            font-size: 24px;
            color: #333;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        body {
            margin: 0;
            padding: 0;
            background: #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            /* Prevent content flash during load */
        }

        #flipbook {
            margin: 0 auto;
        }

        #flipbook .hard {
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            gap: 10px;
        }

        #controls button {
            padding: 8px 15px;
            border: none;
            background: #fff;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }

        #controls button:hover {
            background: #eee;
        }

        .page {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .page img {
            display: block;
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .hard {
            background: none;
        }

        .hard .page {
            width: 100%;
            height: 100%;
        }

        .hard .page img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Special handling for front and back covers */
        .hard:first-child .page img,
        .hard:last-child .page img {
            object-fit: contain;
            max-width: none;
            max-height: none;
        }
    </style>
</head>

<body>
    <div id="loading-screen">
        <div id="loading-text">Loading Scrapbook...</div>
    </div>

    <div id="flipbook">
        <div class="hard">
            <div class="page"><img src="images/g1.gif" alt="Front Cover"></div>
        </div>
        <div class="page"><img src="images/g2.gif" alt="Page 1"></div>
        <div class="page"><img src="images/g3.gif" alt="Page 2"></div>
        <div class="page"><img src="images/g4.gif" alt="Page 3"></div>
        <div class="page"><img src="images/g5.gif" alt="Page 4"></div>
        <div class="page"><img src="images/g6.gif" alt="Page 5"></div>
        <div class="page"><img src="images/g7.gif" alt="Page 6"></div>
        <div class="hard">
            <div class="page"><img src="images/g8.gif" alt="Back Cover"></div>
        </div>
    </div>

    <div id="controls">
        <button onclick="$('#flipbook').turn('previous')">Previous</button>
        <button onclick="$('#flipbook').turn('next')">Next</button>
    </div>

    <script>
        // Cache for preloaded GIFs
        const gifCache = new Map();

        // Preload and optimize GIFs
        const preloadGifs = () => {
            return Promise.all([1, 2, 3, 4, 5, 6, 7, 8].map(num => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        // Pre-calculate optimal dimensions for mobile
                        const screenWidth = window.innerWidth;
                        const screenHeight = window.innerHeight;
                        const maxWidth = screenWidth * (screenWidth < 768 ? 0.9 : 0.8);
                        const maxHeight = screenHeight * (screenWidth < 768 ? 0.9 : 0.8);

                        let width = img.width;
                        let height = img.height;

                        // Scale down if image is larger than max dimensions
                        if (width > maxWidth) {
                            const scale = maxWidth / width;
                            width *= scale;
                            height *= scale;
                        }

                        if (height > maxHeight) {
                            const scale = maxHeight / height;
                            width *= scale;
                            height *= scale;
                        }

                        // Store pre-scaled dimensions with the image
                        img.scaledWidth = width;
                        img.scaledHeight = height;

                        gifCache.set(`g${num}.gif`, img);
                        resolve(img);
                    };
                    img.src = `images/g${num}.gif`;
                });
            }));
        };

        $(document).ready(async function () {
            // Start preloading all GIFs
            await preloadGifs();

            // Get dimensions from the first GIF (now cached)
            const firstGif = gifCache.get('g1.gif');
            const width = firstGif.scaledWidth;
            const height = firstGif.scaledHeight;

            // Show content with smooth transition
            $('#loading-screen').fadeOut(300);
            $('#flipbook, #controls').css({
                visibility: 'visible',
                opacity: 0
            }).animate({ opacity: 1 }, 300);

            // Initialize flipbook with the calculated dimensions
            $('#flipbook').turn({
                width: width * (window.innerWidth < 768 ? 1 : 2),
                height: height,
                autoCenter: true,
                duration: 50,
                gradients: false,
                acceleration: false,
                elevation: 0,
                display: window.innerWidth < 768 ? 'single' : 'double',
                when: {
                    turning: function (e, page, view) {
                        if (window.innerWidth >= 768 && page == 1) {
                            e.preventDefault();
                            $(this).turn('page', 2);
                        }
                    },
                    turned: function (e, page, view) {
                        // After turn animation completes, restart GIFs on visible pages
                        view.forEach(pageNum => {
                            const pageElement = $(this).turn('pages')[pageNum - 1];
                            if (pageElement) {
                                $(pageElement).find('img').each(function () {
                                    // Get the cached GIF
                                    const gifName = this.src.split('/').pop();
                                    const cachedGif = gifCache.get(gifName);
                                    if (cachedGif) {
                                        // Create a new clone to restart animation
                                        const clone = cachedGif.cloneNode(true);
                                        // Preserve the current dimensions
                                        clone.style.width = this.style.width;
                                        clone.style.height = this.style.height;
                                        this.parentNode.replaceChild(clone, this);
                                    }
                                });
                            }
                        });
                    }
                }
            });

            // Update dimensions on window resize
            let resizeTimeout;
            $(window).resize(function () {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function () {
                    const firstGif = gifCache.get('g1.gif');
                    const width = firstGif.scaledWidth;
                    const height = firstGif.scaledHeight;

                    $('#flipbook').turn('size',
                        width * (window.innerWidth < 768 ? 1 : 2),
                        height
                    );

                    // Update display mode if needed
                    const currentDisplay = $('#flipbook').turn('display');
                    const newDisplay = window.innerWidth < 768 ? 'single' : 'double';
                    if (currentDisplay !== newDisplay) {
                        $('#flipbook').turn('display', newDisplay);
                    }
                }, 150);
            });

            $(window).on('keydown', function (e) {
                if (e.keyCode == 37) {
                    $('#flipbook').turn('previous');
                } else if (e.keyCode == 39) {
                    $('#flipbook').turn('next');
                }
            });
        });
    </script>
</body>

</html>