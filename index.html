<!DOCTYPE html>
<html>

<head>
    <title>My Scrapbook</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="js/turn.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #flipbook {
            margin: 0 auto;
        }

        #flipbook .hard {
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            gap: 10px;
        }

        #controls button {
            padding: 8px 15px;
            border: none;
            background: #fff;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }

        #controls button:hover {
            background: #eee;
        }

        .page {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .page img {
            display: block;
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .hard {
            background: none;
        }

        .hard .page {
            width: 100%;
            height: 100%;
        }

        .hard .page img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Special handling for front and back covers */
        .hard:first-child .page img,
        .hard:last-child .page img {
            object-fit: contain;
            max-width: none;
            max-height: none;
        }
    </style>
</head>

<body>
    <div id="flipbook">
        <div class="hard">
            <div class="page"><img src="images/g1.gif" alt="Front Cover"></div>
        </div>
        <div class="page"><img src="images/g2.gif" alt="Page 1"></div>
        <div class="page"><img src="images/g3.gif" alt="Page 2"></div>
        <div class="page"><img src="images/g4.gif" alt="Page 3"></div>
        <div class="page"><img src="images/g5.gif" alt="Page 4"></div>
        <div class="page"><img src="images/g6.gif" alt="Page 5"></div>
        <div class="page"><img src="images/g7.gif" alt="Page 6"></div>
        <div class="hard">
            <div class="page"><img src="images/g8.gif" alt="Back Cover"></div>
        </div>
    </div>

    <div id="controls">
        <button onclick="$('#flipbook').turn('previous')">Previous</button>
        <button onclick="$('#flipbook').turn('next')">Next</button>
    </div>

    <script>
        // Cache for preloaded GIFs
        const gifCache = new Map();

        // Preload all GIFs
        const preloadGifs = () => {
            return Promise.all([1, 2, 3, 4, 5, 6, 7, 8].map(num => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        gifCache.set(`g${num}.gif`, img);
                        resolve(img);
                    };
                    img.src = `images/g${num}.gif`;
                });
            }));
        };

        $(document).ready(async function () {
            // Start preloading all GIFs
            await preloadGifs();

            // Get dimensions from the first GIF (now cached)
            const firstGif = gifCache.get('g1.gif');
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;

            // Calculate dimensions that fit the screen while maintaining aspect ratio
            const maxWidth = screenWidth * 0.8;
            const maxHeight = screenHeight * 0.8;

            let width = firstGif.width;
            let height = firstGif.height;

            // Scale down if image is larger than max dimensions
            if (width * 2 > maxWidth) {
                const scale = maxWidth / (width * 2);
                width *= scale;
                height *= scale;
            }

            if (height > maxHeight) {
                const scale = maxHeight / height;
                width *= scale;
                height *= scale;
            }

            // Initialize flipbook with the calculated dimensions
            $('#flipbook').turn({
                width: width * 2,
                height: height,
                autoCenter: true,
                duration: 1000,
                gradients: false,
                acceleration: true,
                elevation: 50,
                display: 'double',
                when: {
                    turning: function (e, page, view) {
                        if (page == 1) {
                            e.preventDefault();
                            $(this).turn('page', 2);
                        }

                        // Use requestAnimationFrame for smooth GIF reloading
                        requestAnimationFrame(() => {
                            const visiblePages = view.map(function (pageNum) {
                                return $('#flipbook').turn('pages')[pageNum - 1];
                            });
                            $(visiblePages).find('img').each(function () {
                                const gifName = this.src.split('/').pop();
                                // Use cached GIF dimensions for consistent sizing
                                const cachedGif = gifCache.get(gifName);
                                if (cachedGif) {
                                    this.src = this.src.split('?')[0] + '?t=' + Date.now();
                                }
                            });
                        });
                    }
                }
            });

            // Update dimensions on window resize
            let resizeTimeout;
            $(window).resize(function () {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function () {
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;
                    const maxWidth = screenWidth * 0.8;
                    const maxHeight = screenHeight * 0.8;

                    // Use cached first GIF for dimensions
                    const firstGif = gifCache.get('g1.gif');
                    let width = firstGif.width;
                    let height = firstGif.height;

                    if (width * 2 > maxWidth) {
                        const scale = maxWidth / (width * 2);
                        width *= scale;
                        height *= scale;
                    }

                    if (height > maxHeight) {
                        const scale = maxHeight / height;
                        width *= scale;
                        height *= scale;
                    }

                    $('#flipbook').turn('size', width * 2, height);
                }, 150);
            });

            $(window).on('keydown', function (e) {
                if (e.keyCode == 37) {
                    $('#flipbook').turn('previous');
                } else if (e.keyCode == 39) {
                    $('#flipbook').turn('next');
                }
            });
        });
    </script>
</body>

</html>